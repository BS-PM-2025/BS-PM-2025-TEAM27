pipeline {
  agent any

  environment {
    DJANGO_SETTINGS_MODULE = "backend.settings"
    PYTHONUNBUFFERED = 1
  }

  stages {
    stage('Checkout') {
      steps {
        git credentialsId: 'c376752b-6692-4a69-a0d6-8550841e9ee5', url: 'https://github.com/BS-PM-2025/BS-PM-2025-TEAM27'
      }
    }

    stage('Check .env') {
      steps {
        echo "📂 Verifying .env file presence..."
        sh 'ls -la .env'
      }
    }

    stage('Install Python Dependencies') {
      steps {
        echo "🐍 Installing backend dependencies..."
        sh '''
          cd BS-PM-2025-TEAM27
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
        '''
      }
    }

    stage('Run Backend Tests') {
      steps {
        echo "🧪 Running Django unit tests..."
        sh '''
          cd BS-PM-2025-TEAM27
          python3 manage.py test accounts --settings=backend.settings
        '''
      }
    }

    stage('Setup Node.js Locally') {
      steps {
        echo "⚙️ Installing Node.js..."
        sh '''
          cd BS-PM-2025-TEAM27/frontend
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
        '''
      }
    }

    stage('Install Frontend Dependencies') {
      steps {
        echo "📦 Installing frontend dependencies..."
        sh '''
          cd BS-PM-2025-TEAM27/frontend
          npm install
        '''
      }
    }

    stage('Build Frontend') {
      steps {
        echo "🏗️ Building frontend..."
        sh '''
          cd BS-PM-2025-TEAM27/frontend
          npm run build
        '''
      }
    }

    stage('Archive Frontend Build') {
      steps {
        archiveArtifacts artifacts: 'BS-PM-2025-TEAM27/frontend/dist/**', fingerprint: true
      }
    }
  }

  post {
    success {
      echo "✅ Build successful!"
    }
    failure {
      echo "❌ Build failed. Check the logs."
    }
  }
}
